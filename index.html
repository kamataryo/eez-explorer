<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:url" content="https://kamataryo.github.io/eez-explorer" />
  <meta property="og:type" content=" website" />
  <meta property="og:title" content="EEZ Explorer | 排他的経済水域マップ" />
  <meta property="og:description" content="Explore the world EEZ with Web map." />
  <meta property="og:site_name" content="EEZ Explorer | 排他的経済水域マップ" />
  <meta property="og:image" content="https://kamataryo.github.io/eez-explorer/ogp.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@kamataryo_" />
  <title>EEZ Explorer</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div
    id="map"
    data-marker="off"
    data-style="geolonia/gsi"
    data-hash="on"
    data-3d="off"
    data-lang="en"
    data-max-zoom="4.9"
    data-min-zoom="1"
  ></div>
  <div class="center"></div>
  <script src="https://cdn.geolonia.com/dev/embed?geolonia-api-key=YOUR-API-KEY"></script>
  <script src="./main.js"></script>
  <script>
    const main = async () => {
      const map = await mapLoadPromise
      const query = (args) => {
      let point
      let latlng
      if(args.latlng) {
        latlng = args.latlng
        point = map.project(latlng)
      } else {
        point = args.point
        latlng = map.unproject(point)
      }

      const features = map.queryRenderedFeatures(point)
      map.flyTo({ center: latlng, zoom: Math.max(3, map.getZoom()), duration: 200 })
      const eeznames = features
        .filter(({layer}) => layer.source === "eez")
        .map(feature => {
          const geoname = feature.properties.GEONAME.trim()
          const territory = `${feature.properties.TERRITORY1.trim()}`
          return geoname.indexOf(territory) !== -1 ? geoname : `${geoname} (${territory})`
        })
      const eezNameSet = new Set(eeznames)

      setTimeout(() => {
        if(eezNameSet.size > 0) {
          const names = [...eezNameSet].join(', ')
          alert(names)
        } else {
          alert('EEZ 外')
        }
        }, 300)
      }

      class ReverseGeocodeControl {
        constructor(callback) {
          this.callback = callback
        }
        onAdd(map) {
          const container = document.createElement('div')
          const input = document.createElement('input')
          container.appendChild(input)

          container.className = 'mapboxgl-ctrl mapboxgl-ctrl-group maplibregl-ctrl maplibregl-ctrl-group opacity-control-container'
          input.type = 'text'
          input.placeholder = '緯度経度を入力 e.g. 35.123,135.123'
          input.className = 'latlng-input'

          input.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
              try {
                const latlng = input.value.split(/[, \/|、;:\t]+/g).filter(x => !!x).map(val => parseFloat(val)).slice(0, 2)
                latlng.reverse()
                query({ latlng })

              } catch (error) {
                console.log(error)
                alert('緯度経度の値が不正です')
              }
            }
          })
          return container
        }
        remove() {}
      }
      const control = new ReverseGeocodeControl()
      map.addControl(control, 'top-left')
      map.on('click', (event) => query({ point: event.point }))
    }
    main()
  </script>
</body>
</html>
